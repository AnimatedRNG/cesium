<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">  <!-- Use Chrome Frame in IE -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="Point occlusion and region growing example.">
    <meta name="cesium-sandcastle-labels" content="3D Tiles">
    <title>Cesium Demo</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script type="text/javascript" src="../../../ThirdParty/requirejs-2.1.20/require.js"></script>
    <script type="text/javascript">
    require.config({
        baseUrl : '../../../Source',
        waitSeconds : 60
    });
    </script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
<style>
    @import url(../templates/bucket.css);
    #toolbar button { display: block; }
</style>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar">
    <table>
      <tbody>
          <tr>
            <td>Occlusion Angle</td>
            <td>
                <input type="range" min="-1" max="1" step="0.05" data-bind="value: occlusionAngle, valueUpdate: 'input'">
                <input type="text" size="2" data-bind="value: occlusionAngle">
            </td>
          </tr>
          <tr>
            <td>Point Occlusion Filter Size</td>
            <td>
                <input type="range" min="0" max="4" step="1" data-bind="value: neighborhoodHalfWidth, valueUpdate: 'input'">
                <input type="text" size="2" data-bind="value: neighborhoodHalfWidth">
            </td>
          </tr>
          <tr>
            <td>Maximum Region Growing Iterations</td>
            <td>
                <input type="range" min="0" max="10" step="1" data-bind="value: numRegionGrowingPasses, valueUpdate: 'input'">
                <input type="text" size="2" data-bind="value: numRegionGrowingPasses">
            </td>
          </tr>
          <tr>
            <td>Region Growing Range Parameter</td>
            <td>
                <input type="range" min="0" max="1" step="1e-41" data-bind="value: rangeParameter, valueUpdate: 'input'">
                <input type="text" size="2" data-bind="value: rangeParameter">
            </td>
          </tr>
          <tr>
            <td>Maximum Neighborhood Vector Size</td>
            <td>
                <input type="range" min="0.0" max="200.0" step="1e-2" data-bind="value: neighborhoodVectorSize, valueUpdate: 'input'">
                <input type="text" size="2" data-bind="value: neighborhoodVectorSize">
            </td>
          </tr>
          <tr>
            <td>Max Neighborhood ABS ratio</td>
            <td>
                <input type="range" min="0.0" max="1.0" step="1e-2" data-bind="value: maxAbsRatio, valueUpdate: 'input'">
                <input type="text" size="2" data-bind="value: maxAbsRatio">
            </td>
          </tr>
          <tr>
            <td>Point Attenuation Multiplier</td>
            <td>
                <input type="range" min="1.0" max="10.0" step="1" data-bind="value: pointAttenuationMultiplier, valueUpdate: 'input'">
                <input type="text" size="2" data-bind="value: pointAttenuationMultiplier">
            </td>
          </tr>
          <tr>
            <td>AO Sigmoid Domain Offset</td>
            <td>
                <input type="range" min="0.0" max="1.0" step="0.01" data-bind="value: sigmoidDomainOffset, valueUpdate: 'input'">
                <input type="text" size="2" data-bind="value: sigmoidDomainOffset">
            </td>
          </tr>
          <tr>
            <td>AO Sigmoid Sharpness</td>
            <td>
                <input type="range" min="0.0" max="1.0" step="0.01" data-bind="value: sigmoidSharpness, valueUpdate: 'input'">
                <input type="text" size="2" data-bind="value: sigmoidSharpness">
            </td>
          </tr>
        </tbody>
    </table>
</div>
<script id="cesium_sandcastle_script">
function startup(Cesium) {
    'use strict';
//Sandcastle_Begin

var viewer = new Cesium.Viewer('cesiumContainer');
viewer.extend(Cesium.viewerCesium3DTilesInspectorMixin);
var inspectorViewModel = viewer.cesium3DTilesInspector.viewModel;
inspectorViewModel.picking = false;

var scene = viewer.scene;
var url = 'https://beta.cesium.com/api/assets/1460?access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyMzk2YzJiOS1jZGFmLTRlZmYtYmQ4MS00NTA3NjEwMzViZTkiLCJpZCI6NDQsImFzc2V0cyI6WzE0NjBdLCJpYXQiOjE0OTkyNjQ3NTV9.oWjvN52CRQ-dk3xtvD4e8ZnOHZhoWSpJLlw115mbQJM';
var tileset = scene.primitives.add(new Cesium.Cesium3DTileset({
    url : url
}));
tileset.pointCloudPostProcessorOptions.enabled = false;
inspectorViewModel.tileset = tileset;

tileset.readyPromise.then(function() {
    var boundingSphere = tileset.boundingSphere;
    viewer.camera.viewBoundingSphere(boundingSphere, new Cesium.HeadingPitchRange(0.0, -1.0, 50.0));
    viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);
});

var viewModel = {
    occlusionAngle : tileset.pointCloudPostProcessorOptions.occlusionAngle,
    rangeParameter : tileset.pointCloudPostProcessorOptions.rangeParameter,
    numRegionGrowingPasses : tileset.pointCloudPostProcessorOptions.numRegionGrowingPasses,
    neighborhoodHalfWidth : tileset.pointCloudPostProcessorOptions.neighborhoodHalfWidth,
    neighborhoodVectorSize : tileset.pointCloudPostProcessorOptions.neighborhoodVectorSize,
    maxAbsRatio : tileset.pointCloudPostProcessorOptions.maxAbsRatio,
    pointAttenuationMultiplier : tileset.pointCloudPostProcessorOptions.pointAttenuationMultiplier,
    sigmoidDomainOffset : tileset.pointCloudPostProcessorOptions.sigmoidDomainOffset,
    sigmoidSharpness : tileset.pointCloudPostProcessorOptions.sigmoidSharpness
};
Cesium.knockout.track(viewModel);

var toolbar = document.getElementById('toolbar');
Cesium.knockout.applyBindings(viewModel, toolbar);

function subscribeParameter(name) {
    Cesium.knockout.getObservable(viewModel, name).subscribe(
        function(newValue) {
            viewModel[name] = newValue;
            tileset.pointCloudPostProcessorOptions[name] = newValue;
        }
    );
}

subscribeParameter('occlusionAngle');
subscribeParameter('rangeParameter');
subscribeParameter('neighborhoodHalfWidth');
subscribeParameter('numRegionGrowingPasses');
subscribeParameter('neighborhoodVectorSize');
subscribeParameter('maxAbsRatio');
subscribeParameter('pointAttenuationMultiplier');
subscribeParameter('sigmoidDomainOffset');
subscribeParameter('sigmoidSharpness');

Sandcastle.addToggleButton('Enabled', false, function(checked) {
    tileset.pointCloudPostProcessorOptions.enabled = checked;
});

Sandcastle.addToggleButton('Use Triangle Wave', false, function(checked) {
    tileset.pointCloudPostProcessorOptions.useTriangle = checked;
});

Sandcastle.addToggleButton('Enable AO', true, function(checked) {
    tileset.pointCloudPostProcessorOptions.enableAO = checked;
});

Sandcastle.addToggleButton('Display Timer Query', true, function(checked) {
    tileset.pointCloudPostProcessorOptions.useTimerQuery = checked;
});

Sandcastle.addToolbarButton('Save camera', function() {
    var camera = viewer.camera;
    var cameraString = 'camera.position = new Cesium.Cartesian3(' + camera.positionWC.x + ', ' + camera.positionWC.y + ', ' + camera.positionWC.z + ');\n'+
                       'camera.direction = new Cesium.Cartesian3(' + camera.directionWC.x + ', ' + camera.directionWC.y + ', ' + camera.directionWC.z + ');\n'+
                       'camera.right = new Cesium.Cartesian3(' + camera.rightWC.x + ', ' + camera.rightWC.y + ', ' + camera.rightWC.z + ');\n'+
                       'camera.up = new Cesium.Cartesian3(' + camera.upWC.x + ', ' + camera.upWC.y + ', ' + camera.upWC.z + ');\n';
    console.log(cameraString);
});

Sandcastle.addToolbarButton('Run benchmark', function() {
    tileset.pointCloudPostProcessorOptions.useTimerQuery = false;
    var camera = viewer.camera;

    function moveAndGetBenchmark(orientation, name, initial, timeout, startCallback, params) {
        setTimeout(function () {
            tileset.pointCloudPostProcessorOptions.useTimerQuery = false;

            camera.position = orientation.position;
            camera.direction = orientation.direction;
            camera.right = orientation.right;
            camera.up = orientation.up;

            console.log("Currently at " + name + " at time " + initial);

            tileset.pointCloudPostProcessorOptions.useTimerQuery = true;
            startCallback(params);
        }, initial);

        setTimeout(function() {
            tileset.pointCloudPostProcessorOptions.useTimerQuery = false;
            console.log("Finished test. Current time: " + (initial + timeout));
        }, initial + timeout);
    }

    function runTests(orientation, name, currentTime) {
        var curr = currentTime;

        moveAndGetBenchmark(orientation, name, curr + 10, 990, function (params) {
                tileset.pointCloudPostProcessorOptions.enabled = false;
                console.log("Filter off");
        }, {});
        curr += 10000;

        moveAndGetBenchmark(orientation, name, curr + 10, 990, function (params) {
                tileset.pointCloudPostProcessorOptions.enabled = true;
                tileset.pointCloudPostProcessorOptions.AOViewEnabled = false;
                tileset.pointCloudPostProcessorOptions.densityViewEnabled = false;
                tileset.pointCloudPostProcessorOptions.stencilViewEnabled = false;
                tileset.pointCloudPostProcessorOptions.neighborhoodHalfWidth = 4;
                tileset.pointCloudPostProcessorOptions.densityHalfWidth = 4;
                tileset.pointCloudPostProcessorOptions.numRegionGrowingPasses = 5;
                console.log("Filter on theoretical optimium");
        }, {});
        curr += 10000;

        for (var nhw = 1; nhw <= 7; nhw++) {
            moveAndGetBenchmark(orientation, name, curr + 10, 990, function (params) {
                tileset.pointCloudPostProcessorOptions.enabled = true;
                tileset.pointCloudPostProcessorOptions.AOViewEnabled = true;
                tileset.pointCloudPostProcessorOptions.densityViewEnabled = false;
                tileset.pointCloudPostProcessorOptions.stencilViewEnabled = false;
                tileset.pointCloudPostProcessorOptions.neighborhoodHalfWidth = params.nhw;
                tileset.pointCloudPostProcessorOptions.densityHalfWidth = 4;
                tileset.pointCloudPostProcessorOptions.numRegionGrowingPasses = 5;
                console.log("nhw: " + params.nhw);
            }, {nhw : nhw});
            curr += 2000;
        }
        for (var dnhw = 1; dnhw <= 7; dnhw++) {
            moveAndGetBenchmark(orientation, name, curr + 10, 990, function (params) {
                tileset.pointCloudPostProcessorOptions.enabled = true;
                tileset.pointCloudPostProcessorOptions.AOViewEnabled = false;
                tileset.pointCloudPostProcessorOptions.densityViewEnabled = true;
                tileset.pointCloudPostProcessorOptions.stencilViewEnabled = false;
                tileset.pointCloudPostProcessorOptions.neighborhoodHalfWidth = 4;
                tileset.pointCloudPostProcessorOptions.densityHalfWidth = params.dnhw;
                tileset.pointCloudPostProcessorOptions.numRegionGrowingPasses = 5;
                console.log("dnhw: " + params.dnhw);
            }, {dnhw : dnhw});
            curr += 2000;
        }
        for (var rgi = 2; rgi <= 10; rgi++) {
            moveAndGetBenchmark(orientation, name, curr + 10, 990, function (params) {
                tileset.pointCloudPostProcessorOptions.enabled = true;
                tileset.pointCloudPostProcessorOptions.AOViewEnabled = false;
                tileset.pointCloudPostProcessorOptions.densityViewEnabled = false;
                tileset.pointCloudPostProcessorOptions.stencilViewEnabled = true;
                tileset.pointCloudPostProcessorOptions.neighborhoodHalfWidth = 4;
                tileset.pointCloudPostProcessorOptions.densityHalfWidth = 4;
                tileset.pointCloudPostProcessorOptions.numRegionGrowingPasses = params.rgi;
                console.log("rgi: " + params.rgi);
            }, {rgi : rgi});
            curr += 2000;
        }
        return curr;
    }

    var tympanum = {
        position : new Cesium.Cartesian3(4401412.2194143655, 224956.45916124727, 4595140.435677684),
        direction : new Cesium.Cartesian3(0.060398335736332985, 0.9945124651108062, -0.08542246647989672),
        right : new Cesium.Cartesian3(0.7208562925370857, -0.10265383733609339, -0.6854402929430559),
        up : new Cesium.Cartesian3(0.6904478593999468, 0.02017786954568671, 0.7231006894137417)
    }

    var painting = {
        position : new Cesium.Cartesian3(4401414.253304935, 224980.31127410012, 4595140.968069139),
        direction : new Cesium.Cartesian3(-0.8951430504558824, 0.0028263295207434213, 0.4457700428269917),
        right : new Cesium.Cartesian3(-0.014359567855293374, 0.9992781429416056, -0.03517095179527337),
        up : new Cesium.Cartesian3(0.44554766527448775, 0.03788409825528901, 0.8944563002561035)
    };

    var curr = runTests(tympanum, 'tympanum', 10);
    curr = runTests(painting, 'painting', curr);
});

Sandcastle.addToolbarMenu([{
    text : 'Color View',
    onselect : function() {
        tileset.pointCloudPostProcessorOptions.densityViewEnabled = false;
        tileset.pointCloudPostProcessorOptions.stencilViewEnabled = false;
        tileset.pointCloudPostProcessorOptions.aoViewEnabled = false;
    }
}, {
    text : 'Density View',
    onselect : function() {
        tileset.pointCloudPostProcessorOptions.densityViewEnabled = true;
        tileset.pointCloudPostProcessorOptions.stencilViewEnabled = false;
        tileset.pointCloudPostProcessorOptions.aoViewEnabled = false;
    }
}, {
    text : 'Stencil View',
    onselect : function() {
        tileset.pointCloudPostProcessorOptions.densityViewEnabled = false;
        tileset.pointCloudPostProcessorOptions.stencilViewEnabled = true;
        tileset.pointCloudPostProcessorOptions.aoViewEnabled = false;
    }
}, {
    text : 'AO View',
    onselect : function() {
        tileset.pointCloudPostProcessorOptions.densityViewEnabled = false;
        tileset.pointCloudPostProcessorOptions.stencilViewEnabled = false;
        tileset.pointCloudPostProcessorOptions.AOViewEnabled = true;
    }
}]);

//Sandcastle_End
Sandcastle.finishedLoading();
}
if (typeof Cesium !== "undefined") {
    startup(Cesium);
} else if (typeof require === "function") {
    require(["Cesium"], startup);
}
</script>
</body>
</html>
